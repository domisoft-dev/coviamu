<!--
================================================================================
* Project:       https://github.com/domisoft-dev/coviamu
* File:          login.html
* Author:        domisoft-dev
* Description:   Página de login para usuarios de COVIAMU.
*                Permite iniciar sesión verificando credenciales y redirigiendo al panel correspondiente.
================================================================================
* Librerías:
* - Boxicons (https://cdn.boxicons.com)
* - SweetAlert2 (https://cdn.jsdelivr.net/npm/sweetalert2@11)
================================================================================
* Sections Overview:
* - HTML: estructura de la página, navegación y formulario de login
* - JS: funciones handleFormSubmit, loadUsers, updateUser, deleteUser, editUser, clearForm
*       - Manejo de eventos submit del formulario
*       - Envío de datos al endpoint via fetch
*       - Manejo de errores y alertas con SweetAlert2
================================================================================
-->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Login</title>
  <link rel="stylesheet" href="public/css/main.css">
  <script src="public/js/verifyLog.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
</head>
<body>

<nav class="floating-nav">
    <a href="index"><img src="public/img/coviamu.webp" class="coviamuLogo" alt="COVIAMU Logo"></a>
    <div id="txts">
      <ul>
        <li><a href="index">Inicio</a></li>
        <li><a href="index#nosotros">Nosotros</a></li>
        <li><a href="index#contacto">Contacto</a></li>
        <li><a href="login">Mi cuenta</a></li>
        <li><a href="registro" class="btn">Ser parte <i class="bx bx-arrow-up-right-stroke bx-beat"></i></a></li>
      </ul>
    </div>

    <div id="txts">
      <a href="admin">Gestión <i class='bx  bxs-key'  ></i></a>
    </div>
  </nav>

  <h1 class="form-title">Login</h1>

  <form id="user-form" onsubmit="handleFormSubmit(event)">
    <input type="hidden" id="user-id">
    <input type="text" minlength="5" maxlength="32" id="user-name" placeholder="Nombre" required>
    <input type="password" minlength="6" maxlength="16" id="user-contrasena" placeholder="Contrasena" required>
    <button type="submit" class="bold">Continuar</button>
  </form>

  <div id="users"></div>

  <script>
    function loadUsers(name, contrasena) {
  fetch('public/endpointUsers.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, contrasena })
  })
  .then(async res => {
    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch(e) {
      throw new Error("Respuesta inválida del servidor: " + text);
    }

    if (!res.ok) {
      // Lanzar un error para que caiga en catch
      let msg = data.error || 'Error inesperado';
      throw new Error(msg);
    }

    return data;
  })
  .then(data => {
    // Login exitoso
    if (data.success) {
      window.location.href = data.redirect;
    }
  })
  .catch(err => {
    console.error('Error:', err);
    Swal.fire({
      icon: 'error',
      title: 'Ups...',
      text: err.message
    });
  });
}


    function handleFormSubmit(event) {
      event.preventDefault();

      const id = document.getElementById("user-id").value;
      const name = document.getElementById("user-name").value;
      const contrasena = document.getElementById("user-contrasena").value;

      if (id) {
        updateUser(parseInt(id), name, contrasena);
      } else {
        loadUsers(name, contrasena);
      }

      clearForm();
    }


    function updateUser(id, name, email, contrasena, estado) {
      fetch('index.php', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, name, email, contrasena, estado })
      }).then(loadUsers);
    }

    function deleteUser(id) {
      fetch('index.php', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      }).then(loadUsers);
    }

    function editUser(id, name, email, contrasena) {
      document.getElementById("user-id").value = id;
      document.getElementById("user-name").value = name;
      document.getElementById("user-contrasena").value = contrasena;
    }
    function clearForm() {
      document.getElementById("user-id").value = '';
      document.getElementById("user-name").value = '';
      document.getElementById("user-contrasena").value = '';
    }

  </script>

</body>
</html>
