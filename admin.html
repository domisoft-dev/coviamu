<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Gestión</title>
  <link rel="stylesheet" href="public/css/admin.css">
  <script src="public/js/verifyLog.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <h1 class="form-title">Gestión</h1>

  <form id="user-form" onsubmit="handleFormSubmit(event)">
    <input type="hidden" id="user-id">
    <input type="text" id="user-name" placeholder="Nombre" required>
    <input type="text" id="user-contrasena" placeholder="Contrasena" required>
    <button type="submit" class="bold">Continuar</button>
  </form>

  <div id="admins"></div>

  <script>
    function loadUsers(name, contrasena) {
      fetch('public/endpointCooperativas.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre: name, contrasena })
     })
       .then(res => res.json())
       .then(data => {
        if(data.success && data.autenticado){
          Swal.fire({
            icon: 'success',
            title: 'Login',
            text: 'Ha iniciado sesion correctamente'
          })
          window.location.href = data.redirect;
          console.log("Respuesta de checkCooperativas:", data);
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Login',
            text: 'Usuario o contrasena incorrectas'
          })
        }
       })
       .catch(err => console.error("Error en fetch:", err));
    }

    function handleFormSubmit(event) {
      event.preventDefault();

      const id = document.getElementById("user-id").value;
      const name = document.getElementById("user-name").value;
      const contrasena = document.getElementById("user-contrasena").value;

      if (id) {
        updateUser(parseInt(id), name, contrasena);
      } else {
        loadUsers(name, contrasena);
      }

      clearForm();
    }

    function updateUser(id, name, email, contrasena, estado) {
      fetch('index.php', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, name, email, contrasena, estado })
      }).then(loadUsers);
    }

    function deleteUser(id) {
      fetch('index.php', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      }).then(loadUsers);
    }

    function editUser(id, name, email, contrasena) {
      document.getElementById("user-id").value = id;
      document.getElementById("user-name").value = name;
      document.getElementById("user-contrasena").value = contrasena;
    }
    function clearForm() {
      document.getElementById("user-id").value = '';
      document.getElementById("user-name").value = '';
      document.getElementById("user-contrasena").value = '';
    }

  </script>

</body>
</html>